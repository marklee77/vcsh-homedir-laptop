#!/bin/bash 
scriptname="$(basename $0)"
scriptdir="$(dirname $0)"
export PATH="${scriptdir}:$PATH"

lockdir="${XDG_RUNTIME_DIR:-${HOME}/.local/var}/lock"
mkdir -p ${lockdir}

scriptlockdir="${lockdir}/${scriptname}"
pidfile="${scriptlockdir}/PID"
if mkdir ${scriptlockdir} &> /dev/null; then
    trap "rm -rf ${scriptlockdir}; exit 0" EXIT SIGHUP SIGINT SIGQUIT SIGTERM
    echo "$$" > ${pidfile}
else
    otherpid=$(cat ${pidfile} 2>/dev/null)
    othercmd=$(ps --no-headers --format command --pid ${otherpid} 2>/dev/null)
    if [[ "${othercmd}" =~ .*${scriptname}.* ]]; then
        echo "another instance of ${scriptname} is currently running." >&2
        exit 1
    fi
    # lock is stale, remove and try again...
    rm -rf ${scriptlockdir}
    exec "$0" "$@"
fi

logfile="${HOME}/.local/var/log/${scriptname}.log"
exec 1>${logfile}
exec 2>&1

acpi_listen | while read event params; do
    case $event in
        button/lid)
        laptop-acpi-process-event-button_lid &
        ;;
        button/power)
        laptop-acpi-process-event-button_power &
        ;;
        battery)
        laptop-acpi-process-event-battery &
        ;;
    esac
done
