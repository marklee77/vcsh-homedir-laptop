#!/bin/bash
screen_layouts=(left-of right-of mirror)

scriptname="$(basename $0)"

lockdir="${HOME}/.local/var/lock/${scriptname}"
pidfile="${lockdir}/PID"
if mkdir ${lockdir} &> /dev/null; then
    trap "rm -rf ${lockdir}; exit 0" EXIT SIGHUP SIGINT SIGQUIT SIGTERM
    echo "$$" > ${pidfile}
else
    otherpid=$(cat ${pidfile})
    othercmd=$(ps --no-headers --format command --pid ${otherpid})
    if [[ "${othercmd}" =~ .*${scriptname}.* ]]; then
        echo "another instance of ${scriptname} is currently running." >&2
        exit 1
    fi
    # lock is stale, remove and try again...
    rm -rf ${lockdir}
    exec "$0" "$@"
fi

logfile="${HOME}/.local/var/log/${scriptname}.log"
exec 1>${logfile}
exec 2>&1

rundir="${HOME}/.local/var/run/${scriptname}"
mkdir -p ${rundir}
current_layout=$(cat ${rundir}/layout 2>/dev/null)
[ -z "${current_layout}" ] && current_layout=${screen_layouts[0]}

if [ "$1" = "--nocycle" ]; then
    new_layout="${current_layout}"
else
    i=0
    for layout in ${screen_layouts[@]}; do
        i=$((($i + 1) % ${#screen_layouts[@]}))
        [ "${layout}" = "${current_layout}" ] && break
    done
    new_layout=${screen_layouts[$i]}
fi
echo $new_layout > ${rundir}/layout
laptop-screen-set-layout ${new_layout}
