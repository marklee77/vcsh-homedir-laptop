#!/bin/bash
scriptname="$(basename $0)"

lockdir="${XDG_RUNTIME_DIR:-${HOME}/.local/var}/${scriptname}.lock"
pidfile="${lockdir}/PID"
if mkdir ${lockdir} &> /dev/null; then
    trap "rm -rf ${lockdir}; exit 0" EXIT SIGHUP SIGINT SIGQUIT SIGTERM
    echo "$$" > ${pidfile}
else
    otherpid=$(cat ${pidfile} 2>/dev/null)
    othercmd=$(ps --no-headers --format command --pid ${otherpid} 2>/dev/null)
    if [[ "${othercmd}" =~ .*${scriptname}.* ]]; then
        echo "another instance of ${scriptname} is currently running." >&2
        exit 1
    fi
    # lock is stale, remove and try again...
    rm -rf ${lockdir}
    exec "$0" "$@"
fi

logdir="${HOME}/.local/var/log"
mkdir -p ${logdir}

logfile="${logdir}/${scriptname}.log"
#exec 1>${logfile}
#exec 2>&1

rundir="${XDG_RUNTIME_DIR:-${HOME}/.local/var/run}/${scriptname}"
mkdir -p ${rundir}

current_volume_settings=$(cat ${rundir}/settings 2>/dev/null)
if [ -n "$current_volume_settings" ]; then
    amixer -q -c 1 set Master $current_volume_settings
fi

amixer -q -c 1 set Headphone 100% on
amixer -q -c 1 set PCM 100% on

[ -n "$*" ] && amixer -q -c 1 set Master $*

amixer -c 1 get Master | perl -ne 'print "$1 $2\n" if /^\s*Mono:.*\[(.+%)\].*\[.*\].*\[(.+)\].*/' > ${rundir}/settings

pkill -RTMIN+1 i3blocks
