#!/bin/bash
scriptname="$(basename "${BASH_SOURCE[0]}")"
rundir="${XDG_RUNTIME_DIR:-${HOME}/.local/var/run}/${scriptname}"
pidfile="${rundir}/PID"
cleanup () {
    rm -f "${pidfile}"
    flock -u 200
}
mkdir -p "${rundir}"
exec 200>"${pidfile}"
if ! flock -n 200 || ! echo "$$" > "${pidfile}"; then
    echo "another instance of the ${scriptname} is currently running..." >&2
    exit 1
fi
trap cleanup EXIT HUP INT QUIT TERM
scriptdir="$(dirname "${BASH_SOURCE[0]}")"
export PATH="${scriptdir}:$PATH"

# hibernate has been problematic lately...
laptop-suspend
exit 0

battery_charge_hibernate_percent=5
sleep_length=+2hour
battery=BAT0

battery_charge_now="$(cat /sys/class/power_supply/${battery}/charge_now)"
battery_charge_full="$(cat /sys/class/power_supply/${battery}/charge_full)"
battery_charge_percent=$((100*battery_charge_now/battery_charge_full))

if [ ${battery_charge_percent} -le ${battery_charge_hibernate_percent} ]; then
    laptop-hibernate
    exit 0
fi

wakealarm=/sys/class/rtc/rtc0/wakealarm

rtcwake -m no -t "$(date +%s -d"${sleep_length}")"
laptop-suspend

alarm=$(cat ${wakealarm})
now=$(date +%s)

if [ -z ${alarm} ] || [ ${now} -ge ${alarm} ]; then
    xset dpms force off
    sleep 5
    laptop-hibernate
fi
rtcwake -m no -t $(date +%s -d+5seconds)
