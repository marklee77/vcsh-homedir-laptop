#!/bin/bash
HIBERNATE_THRESHOLD_MINUTES=20
SLEEP_LENGTH=+2hour

SCRIPTNAME="$(basename $0)"
LOCKDIR="${HOME}/.local/var/lock/${SCRIPTNAME}"
PIDFILE="${LOCKDIR}/PID"
if mkdir ${LOCKDIR} &> /dev/null; then
    trap "rm -rf ${LOCKDIR}; exit 0" EXIT SIGHUP SIGINT SIGQUIT SIGTERM
    echo "$$" > ${PIDFILE}
else
    OTHERPID=$(cat ${PIDFILE})
    OTHERNAME=$(basename $(ps aux | perl -ane "print \"\$F[11]\\n\" if (\$F[1] == ${OTHERPID});" 2>/dev/null) 2>/dev/null)
    if [ -n "${OTHERPID}" ] && [ "${OTHERNAME}" != "${SCRIPTNAME}" ]; then
        # lock is stale, remove and try again...
        rm -rf ${LOCKDIR}
        exec "$0" "$@"
    fi
    echo "another instance of ${SCRIPTNAME} is currently running." >&2
    exit 1
fi

battery=BAT0
BATTERY_REMAINING_CAPACITY=$(cat /sys/class/power_supply/${battery}/charge_now)
BATTERY_PRESENT_RATE=$(cat /sys/class/power_supply/${battery}/current_now)
BATTERY_MINUTES_REMAINING=$((${BATTERY_REMAINING_CAPACITY}*60/${BATTERY_PRESENT_RATE}))

if [ ${BATTERY_MINUTES_REMAINING} -le ${HIBERNATE_THRESHOLD_MINUTES} ]; then
    laptop-hibernate
    exit 0
fi

WAKEALARM=/sys/class/rtc/rtc0/wakealarm

rtcwake -m no -t $(date +%s -d${SLEEP_LENGTH}) 2>&1 > /dev/null
laptop-suspend

ALARM=$(cat ${WAKEALARM})
NOW=$(date +%s)

if [ -z ${ALARM} ] || [ ${NOW} -ge ${ALARM} ]; then
    xset dpms force off
    sleep 5
    laptop-hibernate
fi
rtcwake -m no -t $(date +%s -d+5seconds) 2>&1 > /dev/null
