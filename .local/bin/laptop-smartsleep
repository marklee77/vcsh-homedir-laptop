#!/bin/bash
scriptname="$(basename $0)"
scriptdir="$(dirname $0)"
export PATH="${scriptdir}:$PATH"

battery_charge_hibernate_percent=5
sleep_length=+2hour
battery=BAT0

lockdir="${HOME}/.local/var/lock/${scriptname}"
pidfile="${lockdir}/PID"
if mkdir ${lockdir} &> /dev/null; then
    trap "rm -rf ${lockdir}; exit 0" EXIT SIGHUP SIGINT SIGQUIT SIGTERM
    echo "$$" > ${pidfile}
else
    otherpid=$(cat ${pidfile} 2>/dev/null)
    othercmd=$(ps --no-headers --format command --pid ${otherpid})
    if [[ "${othercmd}" =~ .*${scriptname}.* ]]; then
        echo "another instance of ${scriptname} is currently running." >&2
        exit 1
    fi
    # lock is stale, remove and try again...
    rm -rf ${lockdir}
    exec "$0" "$@"
fi

logfile="${HOME}/.local/var/log/${scriptname}.log"
exec 1>${logfile}
exec 2>&1

battery_charge_now=$(cat /sys/class/power_supply/${battery}/charge_now)
battery_charge_full=$(cat /sys/class/power_supply/${battery}/charge_full)
battery_charge_percent=$((100*$battery_charge_now/$battery_charge_full))

if [ ${battery_charge_percent} -le ${battery_charge_hibernate_percent} ]; then
    laptop-hibernate
    exit 0
fi

wakealarm=/sys/class/rtc/rtc0/wakealarm

rtcwake -m no -t $(date +%s -d${sleep_length})
laptop-suspend

alarm=$(cat ${wakealarm})
now=$(date +%s)

if [ -z ${alarm} ] || [ ${now} -ge ${alarm} ]; then
    xset dpms force off
    sleep 5
    laptop-hibernate
fi
rtcwake -m no -t $(date +%s -d+5seconds)

