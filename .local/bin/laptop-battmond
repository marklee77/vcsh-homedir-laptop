#!/bin/bash
BATTERY_WARN_MINUTES=10
BATTERY_HIBERNATE_MINUTES=3

SCRIPTNAME="$(basename $0)"
LOCKDIR="${HOME}/.local/var/lock/${SCRIPTNAME}"
PIDFILE="${LOCKDIR}/PID"
if mkdir ${LOCKDIR} &> /dev/null; then
    trap "rm -rf ${LOCKDIR}" EXIT SIGHUP SIGINT SIGQUIT SIGTERM 
    echo "$$" > ${PIDFILE}
else
    OTHERPID=$(cat ${PIDFILE})
    if [ $? = 0 ] && ! kill -0 ${OTHERPID} &> /dev/null; then
        # lock is stale, remove and try again...
        rm -rf ${LOCKDIR}
        exec "$0" "$@"
    fi
    echo "another instance of ${SCRIPTNAME} is currently running." >&2
    exit 1
fi

# This is a pretty simple script to poll the system status and run some simple
# power management scripts. There may be a better way to do this (systemd), but 
# Ubuntu doesn't seem to want to make it easy.

BATTERY_STATUS=ok
while [ 0 = 0 ]; do

    BATTERY_REMAINING_CAPACITY=$(perl -ane 'print "$F[2]\n" if (/^remaining capacity:/);' /proc/acpi/battery/BAT0/state)
    BATTERY_PRESENT_RATE=$(perl -ane 'print "$F[2]\n" if (/^present rate:/);' /proc/acpi/battery/BAT0/state)

    if on_ac_power || [ ${BATTERY_PRESENT_RATE} -le 0 ]; then

        BATTERY_STATUS=ok

    else

        BATTERY_MINUTES_REMAINING=$((${BATTERY_REMAINING_CAPACITY}*60/${BATTERY_PRESENT_RATE}))

        if [ ${BATTERY_STATUS} = "ok" ] &&
           [ ${BATTERY_MINUTES_REMAINING} -lt ${BATTERY_WARN_MINUTES} ]; 
        then

            BATTERY_STATUS=low
            notify-send --urgency=critical \
                "Low Battery Warning!" \
                "The remaining battery charge is critically low. Please connect to AC power."

        elif [ ${BATTERY_STATUS} = "low" ] &&
             [ ${BATTERY_MINUTES_REMAINING} -lt ${BATTERY_HIBERNATE_MINUTES} ]; then

            BATTERY_STATUS=critical

            notify-send --urgency=critical \
                "Hibernating!" \
                "If the computer is not plugged in within the next 30 seconds, hibernation procedures will commence."

            sleep 30

            if ! on_ac_power; then
                laptop-hibernate
            fi

        fi
    fi

    # Let's not use all of the CPU cycles on power management...
    sleep 30

done
